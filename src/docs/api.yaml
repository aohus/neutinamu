openapi: 3.0.3
info:
  title: Photo Clustering & PDF Export API
  version: 1.0.0
  description: >
    사용자가 사진을 업로드하고, 장소별로 클러스터링·수정한 뒤
    각 장소를 1페이지 PDF로 출력하는 서비스의 백엔드 API.

servers:
  - url: http://localhost:8000/

paths:
  /sessions:
    post:
      summary: 업로드 세션 생성
      description: >
        한 번의 작업(최대 1000장 업로드)을 위한 세션을 생성한다.
      requestBody:
        required: false
      responses:
        "201":
          description: 세션 생성됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
              example:
                id: 42
                status: READY
                created_at: "2025-11-26T02:00:00Z"

  /sessions/{sessionId}:
    get:
      summary: 세션 상세 조회
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 세션 정보
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
              example:
                id: 42
                status: READY
                created_at: "2025-11-26T02:00:00Z"

  /sessions/{sessionId}/photos:
    post:
      summary: 세션에 사진 업로드
      description: |
        한 세션에 최대 1000장까지 업로드할 수 있다.
        프론트는 여러 번 호출해도 되며, 서버에서 총 개수 제한을 검증한다.
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
              required: [files]
      responses:
        "201":
          description: 업로드된 사진 리스트
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Photo"
              example:
                - id: 1
                  session_id: 42
                  original_filename: "IMG_0001.jpg"
                  storage_path: "sessions/42/IMG_0001.jpg"
                - id: 2
                  session_id: 42
                  original_filename: "IMG_0002.jpg"
                  storage_path: "sessions/42/IMG_0002.jpg"

  /sessions/{sessionId}/clusters:
    get:
      summary: 세션 내 클러스터 + 사진 목록 조회
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 클러스터 목록
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ClusterDetail"
              example:
                - id: 10
                  session_id: 42
                  name: "대원지하차도 분리대 1"
                  order_index: 0
                  photos:
                    - id: 1
                      original_filename: "IMG_0001.jpg"
                    - id: 3
                      original_filename: "IMG_0003.jpg"
                - id: 11
                  session_id: 42
                  name: "대원지하차도 분리대 2"
                  order_index: 1
                  photos:
                    - id: 5
                      original_filename: "IMG_0005.jpg"

    post:
      summary: 새 클러스터 생성
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClusterCreate"
            example:
              name: "새 장소"
              order_index: 3
      responses:
        "201":
          description: 생성된 클러스터
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClusterDetail"
              example:
                id: 13
                session_id: 42
                name: "새 장소"
                order_index: 3
                photos: []

  /clusters/{clusterId}:
    patch:
      summary: 클러스터 이름/순서 수정
      parameters:
        - in: path
          name: clusterId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClusterUpdate"
            example:
              name: "대원지하차도 분리대(우측)"
              order_index: 2
      responses:
        "200":
          description: 수정된 클러스터
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClusterDetail"

  /clusters/{clusterId}/photos/{photoId}:
    delete:
      summary: 클러스터에서 사진 제거 (삭제)
      parameters:
        - in: path
          name: clusterId
          required: true
          schema:
            type: integer
        - in: path
          name: photoId
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: 성공 (본문 없음)

  /clusters/{clusterId}/move-photo:
    post:
      summary: 사진을 다른 클러스터로 이동
      description: |
        예: 장소2의 9번 사진을 장소3으로 이동
        - src: /clusters/{clusterId}
        - body.target_cluster_id: 3
      parameters:
        - in: path
          name: clusterId
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MovePhotoRequest"
            example:
              photo_id: 9
              target_cluster_id: 11
      responses:
        "204":
          description: 성공 (본문 없음)

  /sessions/{sessionId}/export:
    post:
      summary: 세션 PDF 생성 요청
      description: |
        비동기 작업으로 PDF 생성을 시작한다.
        즉시 결과를 주지 않고, 상태 조회 API를 따로 호출해야 한다.
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      responses:
        "202":
          description: 생성 작업이 큐에 등록됨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportStatus"
              example:
                status: PENDING
                pdf_url: null
                error_message: null

    get:
      summary: PDF 생성 상태 조회
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 현재 export 상태
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportStatus"
              examples:
                pending:
                  value:
                    status: RUNNING
                    pdf_url: null
                    error_message: null
                done:
                  value:
                    status: DONE
                    pdf_url: "/sessions/42/export/download"
                    error_message: null
                failed:
                  value:
                    status: FAILED
                    pdf_url: null
                    error_message: "PDF 생성 중 오류 발생"

  /sessions/{sessionId}/export/download:
    get:
      summary: 생성된 PDF 다운로드
      parameters:
        - in: path
          name: sessionId
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: PDF 파일
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "404":
          description: 아직 생성되지 않았거나, 만료된 경우

components:
  schemas:
    Session:
      type: object
      properties:
        id:
          type: integer
        status:
          type: string
          enum: [UPLOADING, PROCESSING, READY, EXPORTED]
        created_at:
          type: string
          format: date-time

    Photo:
      type: object
      properties:
        id:
          type: integer
        session_id:
          type: integer
        original_filename:
          type: string
        storage_path:
          type: string

    ClusterCreate:
      type: object
      properties:
        name:
          type: string
          nullable: true
          description: "사용자가 입력하는 장소명"
        order_index:
          type: integer
          nullable: true
          description: "PDF 페이지 순서 (0-based)"
      required: []

    ClusterUpdate:
      type: object
      properties:
        name:
          type: string
          nullable: true
        order_index:
          type: integer
          nullable: true
      required: []

    ClusterDetail:
      type: object
      properties:
        id:
          type: integer
        session_id:
          type: integer
        name:
          type: string
          nullable: true
        order_index:
          type: integer
        photos:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              original_filename:
                type: string

    MovePhotoRequest:
      type: object
      properties:
        photo_id:
          type: integer
        target_cluster_id:
          type: integer
      required: [photo_id, target_cluster_id]

    ExportStatus:
      type: object
      properties:
        status:
          type: string
          enum: [PENDING, RUNNING, DONE, FAILED]
        pdf_url:
          type: string
          nullable: true
        error_message:
          type: string
          nullable: true
